name: Lint and Test Chart

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3.5
        with:
          version: v3.13.0

      - name: Build Helm Dependencies
        run: |
          echo "Building Helm dependencies from Chart.lock..."
          helm dependency build
          echo "Dependencies built. Contents of charts/ directory:"
          ls -la charts/ || echo "No charts directory yet"

      - name: Lint Chart
        run: |
          # Lint the main chart
          helm lint .
          
          # Create a minimal test values file for template validation
          cat > test-values.yaml <<EOF
          global:
            timezone: "Europe/Stockholm"
            bitwarden:
              enabled: false
          
          invenio:
            hostname: "test.example.com"
            existingSecret: "test-secrets"
          
          image:
            registry: ghcr.io/inveniosoftware
            repository: demo-inveniordm/demo-inveniordm
            tag: ""
            pullPolicy: IfNotPresent
          
          # Use external services to simplify testing
          opensearch:
            enabled: false
          opensearchExternal:
            hostname: "opensearch"
            port: 9200
          
          rabbitmq:
            enabled: false
          rabbitmqExternal:
            hostname: "rabbitmq"
            amqpPort: 5672
            managementPort: 15672
            username: "user"
            existingSecret: "test-secrets"
            existingSecretPasswordKey: "rabbitmq-password"
            protocol: "amqp"
            vhost: "/"
          
          postgresql:
            enabled: false
          postgresqlExternal:
            hostname: "postgresql"
            port: 5432
            username: "invenio"
            existingSecret: "test-secrets"
            existingSecretPasswordKey: "postgres-password"
            database: "invenio"
          
          redis:
            enabled: false
          redisExternal:
            hostname: "redis"
          
          flower:
            enabled: true
            image: "mher/flower:2.0"
            secret_name: "test-secrets"
          
          web:
            replicas: 1
            resources: 
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi
          
          worker:
            replicas: 1
            concurrency: 1
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi
          
          ingress:
            enabled: false
          
          persistence:
            enabled: false
          EOF
          
          # Dry-run to check templates render with the test values
          echo "Testing template rendering..."
          helm template test-release . -f test-values.yaml --dry-run --debug
          
          # Test specific deployments individually
          echo "Testing web deployment..."
          helm template test-release . -f test-values.yaml --dry-run -s templates/web-deployment.yaml
          
          echo "Testing worker deployment..."
          helm template test-release . -f test-values.yaml --dry-run -s templates/worker-deployment.yaml
          
          echo "Testing flower deployment..."
          helm template test-release . -f test-values.yaml --dry-run -s templates/deployment.yaml
          
          echo "All templates rendered successfully!"