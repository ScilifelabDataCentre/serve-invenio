name: Lint and Test Chart

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3.5
        with:
          version: v3.13.0

      - name: Build Helm Dependencies
        run: |
          echo "Building Helm dependencies from Chart.lock..."
          helm dependency build
          echo "Dependencies built. Contents of charts/ directory:"
          ls -la charts/ || echo "No charts directory yet"

      - name: Lint Chart
        run: |
          # Lint the main chart
          helm lint .
          
          # Dry-run to check templates render (disable dependencies for testing)
          helm template test-release . \
            --set invenio.hostname="test.example.com" \
            --set postgresql.auth.password="test123" \
            --set rabbitmqExternal.password="test456" \
            --set flower.default_password="test789" \
            --set opensearch.enabled=false \
            --set rabbitmq.enabled=false \
            --set redis.enabled=false \
            --set postgresql.enabled=false \
            --dry-run

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          node_image: kindest/node:v1.27.3

      - name: Install Chart in Test Cluster
        run: |
          # Create namespace
          kubectl create namespace test-invenio || true
          
          # Install dependencies first
          kubectl apply -f examples/opensearch.yaml -n test-invenio --wait
          kubectl apply -f examples/rabbit-mq.yaml -n test-invenio --wait
          
          # Create test secrets
          kubectl create secret generic test-secrets -n test-invenio \
            --from-literal=secret-key=test-key \
            --from-literal=security-login-salt=test-salt \
            --from-literal=csrf-secret-salt=test-csrf \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Install the chart with test values (disable built-in dependencies)
          helm upgrade --install test-invenio . -n test-invenio \
            --set invenio.hostname="test.example.com" \
            --set postgresql.enabled=false \
            --set postgresqlExternal.hostname="postgresql" \
            --set postgresqlExternal.username="invenio" \
            --set postgresqlExternal.password="test123" \
            --set postgresqlExternal.database="invenio" \
            --set rabbitmq.enabled=false \
            --set rabbitmqExternal.hostname="rabbitmq" \
            --set rabbitmqExternal.password="test456" \
            --set rabbitmqExternal.username="user" \
            --set opensearch.enabled=false \
            --set opensearchExternal.hostname="opensearch" \
            --set redis.enabled=false \
            --set redisExternal.hostname="redis" \
            --set flower.default_password="test789" \
            --set ingress.enabled=false \
            --set persistence.enabled=false \
            --wait --timeout 5m
          
          # Check if pods are running
          kubectl get pods -n test-invenio
          
          # Clean up
          helm uninstall test-invenio -n test-invenio || true
          kubectl delete namespace test-invenio --wait || true